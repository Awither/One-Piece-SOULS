<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Soul-Soul Fruit Workshop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- Global error banner -->
  <div id="app-error-banner" class="error-banner hidden">
    <span id="app-error-text"></span>
    <button id="app-error-close" type="button">✕</button>
  </div>

  <header class="app-header">
    <div class="app-title">
      <h1>Soul-Soul Fruit Workshop</h1>
      <p>Big Mom–style soul harvesting, Homie crafting, domains, and abilities.</p>
    </div>
    <div class="app-controls">
      <div class="spu-totals">
        <span>Total SPU: <strong id="total-spu">0</strong></span>
        <span>SPU Spent: <strong id="spent-spu">0</strong></span>
        <span>SPU Available: <strong id="available-spu">0</strong></span>
      </div>
      <div class="header-buttons">
        <button id="btn-save" type="button" class="btn secondary">Save Now</button>
        <button id="btn-reset" type="button" class="btn danger">Reset</button>
        <button id="btn-print" type="button" class="btn primary">Print Reference</button>
      </div>
    </div>
  </header>

  <main class="app-main">
    <!-- PANEL 1: Soul Rating & Soul Bank -->
    <section id="panel-souls" class="panel">
      <div class="panel-header">
        <h2>Panel 1 – Soul Rating & Soul Bank</h2>
        <button class="panel-toggle" type="button" aria-label="Toggle panel">▴</button>
      </div>
      <div class="panel-body panel-columns">
        <!-- Left: Soul rating helper -->
        <div class="card">
          <h3>Core Soul Rating (No Math Brain Required)</h3>
          <p class="card-intro">
            Input three things about the target to get a scaled Soul Energy result. This captures
            physical might, combat proficiency, and sheer Willpower.
          </p>

          <div class="field-group">
            <label for="creature-name">Creature Name</label>
            <input id="creature-name" type="text" placeholder="Ex: Terrified Marine Captain" />
          </div>

          <div class="field-group">
            <label for="raw-might">Raw Might (1–10)</label>
            <input id="raw-might" type="number" min="1" max="10" value="5" />
            <p class="helper-text">How physically / combat capable they are at baseline.</p>
          </div>

          <div class="field-group">
            <label for="proficiency-tier">Proficiency Tier (0–9)</label>
            <select id="proficiency-tier">
              <option value="0">0 – Untrained (civilian / fodder)</option>
              <option value="1">1 – Basic training (rookie marine)</option>
              <option value="2">2 – Seasoned fighter</option>
              <option value="3">3 – Veteran marine</option>
              <option value="4">4 – Elite marine / Rear Admiral</option>
              <option value="5">5 – Admiral</option>
              <option value="6">6 – Vice Admiral</option>
              <option value="7">7 – Yonko</option>
              <option value="8">8 – Gorosei</option>
              <option value="9">9 – Beyond mortal limits</option>
            </select>
            <p class="helper-text">Their “skill tier” in the world. Heavily influences the soul rating.</p>
          </div>

          <div class="field-group">
            <label for="willpower-level">Willpower Level (1–10)</label>
            <input id="willpower-level" type="number" min="1" max="10" value="5" />
            <p class="helper-text">How unbreakable their spirit is. This is the most important factor.</p>
          </div>

          <div class="computed-fields">
            <div>Combined Soul Rating: <span id="combined-soul-rating">0</span></div>
            <div>Soul Level (SoL): <span id="soul-level">1</span></div>
            <div>Soul Energy (SPU): <span id="soul-energy">0</span></div>
            <div>Suggested Max HP Lost: <span id="soul-max-hp-lost">0</span></div>
          </div>

          <div class="field-group">
            <label for="soul-traits">Traits / Tags (optional)</label>
            <input id="soul-traits" type="text" placeholder="Ex: cowardly, marine, zealot" />
          </div>

          <div class="field-group">
            <label for="soul-notes">Soul Notes</label>
            <textarea id="soul-notes" class="auto-resize" placeholder="Flavor, backstory, what broke their will, how they reacted..."></textarea>
          </div>

          <div class="button-row">
            <button id="btn-recalc-soul" type="button" class="btn secondary">Recalculate Soul Rating</button>
            <button id="btn-add-soul" type="button" class="btn primary">Add Soul to Bank</button>
          </div>
        </div>

        <!-- Right: Soul bank -->
        <div class="card">
          <h3>Soul Bank</h3>
          <p class="card-intro">
            All harvested souls are stored here with their Soul Level and Soul Energy. Toggle crafting
            availability or mark a target as Soul-Rip Immune for the day.
          </p>

          <div class="field-group inline">
            <label for="soul-filter-input">Filter by name / trait</label>
            <input id="soul-filter-input" type="text" placeholder="Search souls..." />
          </div>

          <div id="soul-bank-list" class="card-list empty-message">
            <p>No souls yet. Harvest some in the left panel and add them to the bank.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- PANEL 2: Homies -->
    <section id="panel-homies" class="panel">
      <div class="panel-header">
        <h2>Panel 2 – Homies (Creation & Upgrades)</h2>
        <button class="panel-toggle" type="button" aria-label="Toggle panel">▴</button>
      </div>
      <div class="panel-body panel-columns">
        <!-- Left: Create homie -->
        <div class="card">
          <h3>Create a Homie</h3>
          <p class="card-intro">
            Spend Soul Energy (SPU) once to create Minor, Territory, Buff, or Signature Homies. Each
            Homie tracks total SPU invested and can be upgraded or revived later.
          </p>

          <div class="field-group">
            <label for="homie-name">Homie Name</label>
            <input id="homie-name" type="text" placeholder="Ex: Prometheus, Zephyr Gate" />
          </div>

          <div class="field-group">
            <label for="homie-type">Homie Type</label>
            <select id="homie-type">
              <option value="Minor">Minor Homie (tools, plants, toys)</option>
              <option value="Territory">Territory Homie (roads, walls, statues)</option>
              <option value="Buff">Buff Homie (auras, support)</option>
              <option value="Signature">Signature Homie (elite companions)</option>
            </select>
          </div>

          <div class="field-group">
            <label for="homie-linked-soul">Linked Soul (optional)</label>
            <select id="homie-linked-soul">
              <option value="">— None / Composite —</option>
            </select>
            <p class="helper-text">For personality or mechanical flavor links. Purely reference.</p>
          </div>

          <div class="field-group">
            <label for="homie-initial-spu">Initial SPU Investment</label>
            <input id="homie-initial-spu" type="number" min="0" value="10" />
            <p class="helper-text">
              SPU you dedicate to bring the Homie into existence. More SPU = sturdier or more powerful.
            </p>
          </div>

          <div class="field-group">
            <label for="homie-role">Role / Concept</label>
            <input id="homie-role" type="text" placeholder="Ex: front-line bruiser, healer, scout" />
          </div>

          <div class="field-group three-cols">
            <div>
              <label for="homie-hp">HP (for combat / Signature Homies)</label>
              <input id="homie-hp" type="text" placeholder="Ex: 85 (10d8+30)" />
            </div>
            <div>
              <label for="homie-ac">AC</label>
              <input id="homie-ac" type="text" placeholder="Ex: 17 (soul armor)" />
            </div>
            <div>
              <label for="homie-move">Movement</label>
              <input id="homie-move" type="text" placeholder="Ex: 30 ft., fly 40 ft." />
            </div>
          </div>

          <div class="field-group">
            <label for="homie-primary-damage">Primary Damage / Attack</label>
            <input id="homie-primary-damage" type="text" placeholder="Ex: 2d10 fire, 3d8 lightning" />
          </div>

          <div class="field-group">
            <label for="homie-abilities">Homie Abilities</label>
            <textarea id="homie-abilities" class="auto-resize" placeholder="Named abilities, how they fight, what support they give, etc."></textarea>
          </div>

          <div class="field-group">
            <label for="homie-traits">Personality Traits (from souls used)</label>
            <textarea id="homie-traits" class="auto-resize" placeholder="Ex: arrogant, gluttonous, storm-obsessed, jealous, loyal."></textarea>
          </div>

          <div class="field-group">
            <label for="homie-bound-location">Bound Location (Territory Homies)</label>
            <input id="homie-bound-location" type="text" placeholder="Ex: Southern Gate of Montblanc City" />
          </div>

          <div class="field-group">
            <label for="homie-assigned-domain">Assigned Domain</label>
            <select id="homie-assigned-domain">
              <option value="">— None yet —</option>
            </select>
          </div>

          <div class="field-group">
            <label for="homie-territory-actions">Territory Actions</label>
            <textarea id="homie-territory-actions" class="auto-resize" placeholder="Walls closing, roads shifting, ambush routes, etc."></textarea>
          </div>

          <div class="field-group">
            <label for="homie-buff-effects">Buff / Support Effects</label>
            <textarea id="homie-buff-effects" class="auto-resize" placeholder="Healing aura, +2 to saves, once-per-round advantage, temporary HP, etc."></textarea>
          </div>

          <div class="button-row">
            <button id="btn-create-homie" type="button" class="btn primary">Create Homie</button>
          </div>
        </div>

        <!-- Right: Homie roster & AI attack forge -->
        <div class="card">
          <h3>Homie Roster & Upgrades</h3>
          <p class="card-intro">
            Upgrade HP, AC, Damage, and Utility tiers by spending SPU. When a Homie is destroyed, pay
            half of its SPU invested to revive it. Use the AI Attack Forge to generate signature moves.
          </p>

          <div class="field-group inline">
            <label for="homie-filter-input">Filter Homies</label>
            <input id="homie-filter-input" type="text" placeholder="Search homies..." />
          </div>

          <div class="sub-card">
            <h4>AI Homie Attack Forge</h4>
            <p class="helper-text">
              Pick a Homie, describe the vibe of the attack, choose effect types and power level, and
              let the souls craft a full multi-step move (including damage dice, DCs, and conditions).
            </p>

            <div class="field-group">
              <label for="ai-homie-target">Target Homie</label>
              <select id="ai-homie-target">
                <option value="">— Select Homie —</option>
              </select>
            </div>

            <div class="field-group">
              <label for="ai-homie-concept">Attack Concept</label>
              <textarea id="ai-homie-concept" class="auto-resize" placeholder="Ex: Storm homie unleashes a chained lightning barrage that refuels a fire homie while shredding armor."></textarea>
            </div>

            <div class="field-group">
              <span class="field-label">Effect Types</span>
              <div class="checkbox-row">
                <label><input type="checkbox" name="ai-homie-effect-types" value="Offense" /> Offense</label>
                <label><input type="checkbox" name="ai-homie-effect-types" value="Defense" /> Defense</label>
                <label><input type="checkbox" name="ai-homie-effect-types" value="Support" /> Support</label>
                <label><input type="checkbox" name="ai-homie-effect-types" value="Control" /> Control</label>
                <label><input type="checkbox" name="ai-homie-effect-types" value="Utility" /> Utility</label>
                <label><input type="checkbox" name="ai-homie-effect-types" value="Reality-Bending" /> Reality-Bending</label>
              </div>
            </div>

            <div class="field-group">
              <label for="ai-homie-power-level">Power Level (1–10)</label>
              <input id="ai-homie-power-level" type="number" min="1" max="10" value="7" />
              <p class="helper-text">1 = simple, 10 = elaborate multi-step move at high damage (think ~30d12).</p>
            </div>

            <div class="button-row">
              <button id="btn-generate-homie-attack" type="button" class="btn secondary">Generate Attack (AI)</button>
            </div>
          </div>

          <div id="homie-roster-list" class="card-list empty-message">
            <p>No Homies yet. Create one in the left column.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- PANEL 3: Domains & Territories -->
    <section id="panel-domains" class="panel">
      <div class="panel-header">
        <h2>Panel 3 – Domains & Territories</h2>
        <button class="panel-toggle" type="button" aria-label="Toggle panel">▴</button>
      </div>
      <div class="panel-body panel-columns">
        <!-- Left: Create domain -->
        <div class="card">
          <h3>Create a Domain</h3>
          <p class="card-intro">
            Build Big Mom–style territories. Invest SPU, set a passive Fear DC, and bind Territory
            Homies to shape the land. Environment personality and setup drive AI-generated lair actions.
          </p>

          <div class="field-group">
            <label for="domain-name">Domain Name</label>
            <input id="domain-name" type="text" placeholder="Ex: Totto Land: Candy Coast" />
          </div>

          <div class="field-group three-cols">
            <div>
              <label for="domain-tier">Domain Tier (1–10)</label>
              <input id="domain-tier" type="number" min="1" max="10" value="3" />
            </div>
            <div>
              <label for="domain-spu">SPU Invested into Domain</label>
              <input id="domain-spu" type="number" min="0" value="10" />
            </div>
            <div>
              <label for="domain-fear-dc">Passive Fear DC (entering enemies)</label>
              <input id="domain-fear-dc" type="number" min="0" value="15" />
            </div>
          </div>

          <div class="field-group">
            <label for="domain-size">Territory Size / Range</label>
            <input id="domain-size" type="text" placeholder="Ex: 5-mile radius around the main island" />
          </div>

          <div class="field-group">
            <label for="domain-personality">Environmental Personality</label>
            <textarea id="domain-personality" class="auto-resize" placeholder="Ex: sweets-obsessed, singing weather, jealous forests, gossiping rivers."></textarea>
          </div>

          <div class="field-group">
            <label for="domain-lair-actions">Lair Actions (manual or AI-written)</label>
            <textarea id="domain-lair-actions" class="auto-resize" placeholder="You can write your own or generate with AI per domain card."></textarea>
          </div>

          <div class="field-group">
            <label for="domain-notes">Domain Notes</label>
            <textarea id="domain-notes" class="auto-resize"></textarea>
          </div>

          <div class="field-group">
            <label for="domain-territory-homies">Assign Territory Homies</label>
            <select id="domain-territory-homies" multiple>
            </select>
            <p class="helper-text">Hold Ctrl/Cmd to select multiple Territory Homies.</p>
          </div>

          <div class="button-row">
            <button id="btn-create-domain" type="button" class="btn primary">Create Domain</button>
          </div>
        </div>

        <!-- Right: Domains overview -->
        <div class="card">
          <h3>Domains Overview</h3>
          <p class="card-intro">
            Manage your Domains: see their fear pressure, control radius, and which Territory Homies
            guard them. Use the AI buttons on each card to roll domain-specific lair actions.
          </p>

          <div class="field-group inline">
            <label for="domain-filter-input">Filter Domains</label>
            <input id="domain-filter-input" type="text" placeholder="Search domains..." />
          </div>

          <div id="domain-list" class="card-list empty-message">
            <p>No Domains yet. Build one in the left column.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- PANEL 5: Ability Cards (Manual & AI) -->
    <section id="panel-abilities" class="panel">
      <div class="panel-header">
        <h2>Panel 4 – Ability Cards (Manual & AI)</h2>
        <button class="panel-toggle" type="button" aria-label="Toggle panel">▴</button>
      </div>
      <div class="panel-body panel-columns">
        <!-- Left: create / forge ability -->
        <div class="card">
          <h3>Create / Forge Ability</h3>
          <p class="card-intro">
            Either create abilities manually or let the souls forge them based on effect types, desired
            outcomes, power level, and an optional soul cost.
          </p>

          <div class="field-group">
            <label for="ability-name">Ability Name</label>
            <input id="ability-name" type="text" placeholder="Ex: Soul-Storm Judgment" />
          </div>

          <div class="field-group">
            <label for="ability-assign-to">Assign To</label>
            <select id="ability-assign-to">
              <option value="General / Party">General / Party</option>
            </select>
          </div>

          <div class="field-group three-cols">
            <div>
              <label for="ability-action-type">Action Type</label>
              <input id="ability-action-type" type="text" placeholder="Ex: Action, Bonus Action, Reaction" />
            </div>
            <div>
              <label for="ability-range">Range</label>
              <input id="ability-range" type="text" placeholder="Ex: Self, 30 ft., 60 ft. cone" />
            </div>
            <div>
              <label for="ability-target">Target</label>
              <input id="ability-target" type="text" placeholder="Ex: Single creature, 3 creatures" />
            </div>
          </div>

          <div class="field-group two-cols">
            <div>
              <label for="ability-save-dc">Save / DC</label>
              <input id="ability-save-dc" type="text" placeholder="Ex: Wis save vs. DC 18, no save" />
            </div>
            <div>
              <label for="ability-damage">Damage Dice</label>
              <input id="ability-damage" type="text" placeholder="Ex: 6d10 necrotic + 4d8 thunder" />
            </div>
          </div>

          <div class="field-group two-cols">
            <div>
              <label for="ability-power-level">Ability Power Level (1–10)</label>
              <input id="ability-power-level" type="number" min="1" max="10" value="7" />
            </div>
            <div>
              <label for="ability-soul-cost">Soul Energy Used (optional)</label>
              <input id="ability-soul-cost" type="number" min="0" value="0" />
            </div>
          </div>

          <div class="field-group">
            <span class="field-label">Effect Types</span>
            <div class="checkbox-row">
              <label><input type="checkbox" name="ability-effect-types" value="Offense" /> Offense</label>
              <label><input type="checkbox" name="ability-effect-types" value="Defense" /> Defense</label>
              <label><input type="checkbox" name="ability-effect-types" value="Support" /> Support</label>
              <label><input type="checkbox" name="ability-effect-types" value="Control" /> Control</label>
              <label><input type="checkbox" name="ability-effect-types" value="Utility" /> Utility</label>
              <label><input type="checkbox" name="ability-effect-types" value="Reality-Bending" /> Reality-Bending</label>
            </div>
          </div>

          <div class="field-group">
            <label for="ability-effect-notes">Effect Notes</label>
            <textarea id="ability-effect-notes" class="auto-resize" placeholder="Clarify how you want damage, buffs, debuffs, or healing to behave."></textarea>
          </div>

          <div class="field-group">
            <span class="field-label">Desired Outcome / Ability Shape</span>
            <div class="checkbox-row multi-line">
              <label><input type="checkbox" name="ability-outcome-types" value="Barrier / Shield" /> Barrier / Shield</label>
              <label><input type="checkbox" name="ability-outcome-types" value="Restrain / Bind" /> Restrain / Bind</label>
              <label><input type="checkbox" name="ability-outcome-types" value="Area Denial / Zone" /> Area Denial / Zone</label>
              <label><input type="checkbox" name="ability-outcome-types" value="Morphing / Weapon Form" /> Morphing / Weapon Form</label>
              <label><input type="checkbox" name="ability-outcome-types" value="Overcharge / Self-Buff" /> Overcharge / Self-Buff</label>
              <label><input type="checkbox" name="ability-outcome-types" value="Mobility / Gap Closer / Escape" /> Mobility / Gap Closer / Escape</label>
              <label><input type="checkbox" name="ability-outcome-types" value="Debuff / Weakening" /> Debuff / Weakening</label>
              <label><input type="checkbox" name="ability-outcome-types" value="Explosion / Burst" /> Explosion / Burst</label>
              <label><input type="checkbox" name="ability-outcome-types" value="High Damage / Burst Focus" /> High Damage / Burst Focus</label>
              <label><input type="checkbox" name="ability-outcome-types" value="Battlefield Control" /> Battlefield Control</label>
              <label><input type="checkbox" name="ability-outcome-types" value="Signature Finisher" /> Signature Finisher</label>
            </div>
          </div>

          <div class="field-group">
            <label for="ability-outcome-notes">Outcome / Effect Notes</label>
            <textarea id="ability-outcome-notes" class="auto-resize" placeholder="Describe what you want the move to look like in the scene and the exact outcome."></textarea>
          </div>

          <div class="field-group">
            <label for="ability-mechanical-effect">Mechanical Effect</label>
            <textarea id="ability-mechanical-effect" class="auto-resize" placeholder="What happens on hit / failed save, conditions, battlefield changes, etc."></textarea>
          </div>

          <div class="field-group">
            <label for="ability-combo-notes">Combo / Interaction Notes</label>
            <textarea id="ability-combo-notes" class="auto-resize" placeholder="How this interacts with Homies, Domains, or other abilities."></textarea>
          </div>

          <div class="button-row">
            <button id="btn-create-ability-manual" type="button" class="btn primary">Create Ability Manually</button>
            <button id="btn-create-ability-ai" type="button" class="btn secondary">Generate via AI</button>
          </div>
        </div>

        <!-- Right: Ability list -->
        <div class="card">
          <h3>Ability List</h3>
          <p class="card-intro">
            Browse all abilities – manual and AI-generated. Names and text are editable. Use the copy
            button on each card to paste into your character sheet.
          </p>

          <div class="field-group inline">
            <label for="ability-filter-input">Filter Abilities</label>
            <input id="ability-filter-input" type="text" placeholder="Search abilities..." />
          </div>

          <div id="ability-list" class="card-list empty-message">
            <p>No abilities yet. Create or generate one in the left column.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- PANEL 6: Soul Party Dashboard -->
    <section id="panel-summary" class="panel">
      <div class="panel-header">
        <h2>Panel 5 – Soul Party Dashboard (Printable)</h2>
        <button class="panel-toggle" type="button" aria-label="Toggle panel">▴</button>
      </div>
      <div class="panel-body">
        <p class="card-intro">
          Snapshot of your Homies, Domains, and key stats. This panel is print-optimized and becomes the
          main reference sheet when you hit “Print Reference”.
        </p>

        <div class="button-row">
          <button id="btn-refresh-summary" type="button" class="btn secondary">Refresh Summary</button>
        </div>

        <div id="summary-list" class="card-list empty-message">
          <p>No entries yet. Create Homies and Domains to populate the dashboard.</p>
        </div>
      </div>
    </section>

    <!-- PANEL 7: Help & Troubleshooting -->
    <section id="panel-help" class="panel">
      <div class="panel-header">
        <h2>Panel 6 – Help & Troubleshooting</h2>
        <button class="panel-toggle" type="button" aria-label="Toggle panel">▴</button>
      </div>
      <div class="panel-body">
        <div class="card">
          <h3>Common Problems & Fixes</h3>

          <h4>1. AI buttons do nothing or show an error</h4>
          <ul class="help-list">
            <li>Make sure you are <strong>not</strong> opening <code>index.html</code> directly from your file system.</li>
            <li>Run the app through a server instead (for example <code>vercel dev</code>, or any Node static server).</li>
            <li>
              In your environment, set
              <code>OPENAI_API_KEY</code> to a valid OpenAI key, then redeploy or restart your dev server.
            </li>
            <li>Open DevTools → Console and look for messages starting with <strong>[Soul Workshop Error]</strong>.</li>
          </ul>

          <h4>2. Soul Bank doesn’t update or show new souls</h4>
          <ul class="help-list">
            <li>Make sure you clicked <strong>“Recalculate Soul Rating”</strong> first to see the new values.</li>
            <li>Then click <strong>“Add Soul to Bank”</strong>. A card should appear on the right side.</li>
            <li>If nothing appears and an error banner shows, read the message or open the console for details.</li>
            <li>Click <strong>Reset</strong> to clear localStorage if the state seems corrupted.</li>
          </ul>

          <h4>3. Layout looks broken / unreadable</h4>
          <ul class="help-list">
            <li>Use a modern browser (Chrome, Edge, Firefox, or a current Chromium-based browser).</li>
            <li>If cards are overlapping, try a hard refresh (Ctrl+F5) or disable browser extensions that inject CSS.</li>
            <li>On narrow screens, panels stack in a single column. On wide screens, each panel uses two columns internally.</li>
          </ul>

          <h4>4. How error messages work</h4>
          <ul class="help-list">
            <li>Any caught error is displayed in the red banner at the top of the page.</li>
            <li>Click the <strong>✕</strong> on the banner to hide it once you’ve read it.</li>
            <li>Errors also log to the browser console with the prefix <strong>[Soul Workshop Error]</strong>.</li>
          </ul>
        </div>
      </div>
    </section>
  </main>

  <script src="script.js"></script>
</body>
</html>
